<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-data/sql/optimistic-pessimistic-locking-sql">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileColor" content="#000000">
<meta name="theme-color" content="#ffffff">

<script>const style=document.createElement("style");style.type="text/css",style.textContent=".menu .menu__list .menu__list-item.menu__list-item--collapsed .menu__list{height:0;overflow:hidden}.menu .menu__list .menu__link.menu__link--sublist:after{visibility:visible}.menu .menu__list .menu__list-item.menu__list-item--collapsed .menu__link--sublist:after{visibility:visible}",document.getElementsByTagName("head")[0].appendChild(style)</script><title data-rh="true">Optimistic and pessimistic locking in SQL | interview-prep</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://shyamzzp.github.io/interview-prep/data/sql/optimistic-pessimistic-locking-sql"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Optimistic and pessimistic locking in SQL | interview-prep"><meta data-rh="true" name="description" content="How and why to use locking with relational databases"><meta data-rh="true" property="og:description" content="How and why to use locking with relational databases"><link data-rh="true" rel="icon" href="/interview-prep/favicon.ico"><link data-rh="true" rel="canonical" href="https://shyamzzp.github.io/interview-prep/data/sql/optimistic-pessimistic-locking-sql"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview-prep/data/sql/optimistic-pessimistic-locking-sql" hreflang="en"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview-prep/data/sql/optimistic-pessimistic-locking-sql" hreflang="x-default"><link rel="stylesheet" href="/interview-prep/assets/css/styles.2935aefe.css">
<link rel="preload" href="/interview-prep/assets/js/runtime~main.a06935e2.js" as="script">
<link rel="preload" href="/interview-prep/assets/js/main.05638695.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script>

<svg style="display: none;"><desc>Font Awesome Free 5.13.0 by @fontawesome - https://fontawesome.com
            License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)</desc>
            <symbol id="external-link-alt" viewBox="0 0 512 512">
                <path d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path>
            </symbol>
            <symbol id="github" viewBox="0 0 496 512">
                <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path>
            </symbol></svg><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/interview-prep/"><b class="navbar__title text--truncate">Interview Preparation Notes</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shyamzzp/interview-prep" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link navbar__item navbar__link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/about/">About</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/interview-prep/data/cap-theorem">Data</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview-prep/data/cap-theorem">CAP theorem</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview-prep/data/data-schema-migration">Data schema migration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview-prep/data/sql-nosql-newsql">SQL, NoSQL, NewSQL</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/interview-prep/data/sql/acid">SQL</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/interview-prep/data/sql/acid">ACID properties</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/interview-prep/data/sql/normalization">Database normalization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interview-prep/data/sql/optimistic-pessimistic-locking-sql">Optimistic and pessimistic locking in SQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/interview-prep/data/sql/transaction-isolation-levels">Transaction isolation levels</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/java/concurrency">Java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/javascript/event-loop">JavaScript</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/leetcode-questions/medium">Leetcode Questions (Java)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/mindset/ask-dumb-questions">Mindset</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/preparation/algorithms">Preparation (Java)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/processes-techniques/branch-by-abstraction-application-strangulation">Processes and techniques</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/soft-skills/expectation-management">Soft skills</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview-prep/web/cookies-web-storage">Web</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interview-prep/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Data</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">SQL</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Optimistic and pessimistic locking in SQL</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Optimistic and pessimistic locking in SQL</h1></header><p>How and why to use locking with relational databases</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-locking">Why locking?<a class="hash-link" href="#why-locking" title="Direct link to heading">​</a></h2><p>Concurrency!</p><p>Some scenarios:</p><ul><li>Your application lets users manage items. Each item has a long description. One of your users starts editing the description of item A at 10:00 and saves his changes at 10:02. Meanwhile, another user starts editing the same item’s description at 10:01 and saves it at 10:03. Because the original description that the second user started from did not yet contain the changes made by the first user, the changes made by the first user are lost without either user being notified about it.</li><li>Your application communicates with the database through an ORM using the common approach where you retrieve the current version of an object, make some changes to it and then save the entire resulting object to the database. Some user or process changes the same object right after you retrieved it, so the object you are saving does not contain those changes. This leads to your application overwriting the changes with stale data.</li><li>Your application allows linking items to a group, but only if the group has status “Active”. This restriction is not enforced at the database-level. Before linking an item to a group, you verify that the group has the correct status. However, just before you save the item, another user or process changes the status of the group to “Inactive”. Once you commit, the item is now linked to an inactive group.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimistic-locking">Optimistic locking<a class="hash-link" href="#optimistic-locking" title="Direct link to heading">​</a></h2><p>(some prefer the term &quot;optimistic concurrency control&quot;  because, unlike pessimistic locking, it does not explicitly lock resources)</p><ul><li>Perform most of the operation under assumption that no conflicting operations have occurred</li><li>Just before saving/committing, verify that no conflicts have occurred and abort otherwise</li></ul><p>In SQL, two approaches:</p><ul><li>Compare actual data to data you based yourself on when performing the operation</li><li>Using a version number or timestamp that changes ever time the data changes</li></ul><p>Can be used to retrieve object, make some changes to it and then save and verify that no other changes have been made in the meantime. Could also use same mechanism to verify that a certain object you needed simply didn&#x27;t change.</p><p>Benefits:</p><ul><li>Flexibility: don&#x27;t have to care about where or when the &quot;base version&quot; was retrieved. Could have been in different transaction, could have been 15 minutes ago when a user started editing, ...</li><li>Deadlocks are less likely and it&#x27;s straightforward to prevent them by always saving object in same order (DB-level locks are only acquired when saving)</li></ul><p>Drawbacks:</p><ul><li>If conflict does occur, you need to deal with operation being aborted<ul><li>Retrying can make sense in some scenarios<ul><li>Example: ORM retrieves object, makes changes and immediately saves it. If the operation fails, we can retrieve the most recent version and then try making our changes on that one.</li><li>Note: a conflict means that data has changed, might invalidate some precondition!</li><li>Note: retry attempts should likely be limited, leading to the possibility for failure again!</li></ul></li><li>Retrying does not make sense in first scenario (users concurrently editing descriptions), because it would just let users unknowingly overwrite each other&#x27;s changes again. Here, we need user input (e.g. manual merging of changes)!</li></ul></li><li>Not ideal if there&#x27;s lot of conflicting access to the same resource<ul><li>In that case, you would be aborting operations all the time</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pessimistic-locking">Pessimistic locking<a class="hash-link" href="#pessimistic-locking" title="Direct link to heading">​</a></h2><ul><li>Assume conflicting operations will occur</li><li>Actively block anything that might lead to a conflict</li></ul><p>Works by actively locking database rows (or even entire tables) that you need in your operation.</p><p>Types of locks:</p><ul><li>Shared locks (read locks): <ul><li>use on data you just need to stay the same until your operation completes</li><li>allow other shared locks on the same data</li></ul></li><li>Exclusive locks (write locks):<ul><li>use for reading and writing data you want to update</li><li>do not allow any other lock on the same data before transaction is committed or rolled back</li></ul></li></ul><p>Attempts to obtain a lock when it&#x27;s not allowed will typically block until the conflicting locks are released -&gt; deadlock potential!</p><p>Benefits:</p><ul><li>Completely prevents conflicts from occurring! <ul><li>Could actually be best-performing strategy in high-concurrency environments</li></ul></li></ul><p>Drawbacks</p><ul><li>Misses the flexibility of optimistic locking: everything needs to happen inside same DB transaction<ul><li>Impractical for scenarios that need to wait for user input (and what if input never comes?)</li><li>Can limit options for the way codebase is organized</li></ul></li><li>Could unnecessarily limit concurrency</li><li>Special care needed to prevent deadlocks!<ul><li>Locks acquired at start of operation -&gt; more locking</li><li>Less flexibility regarding order in which locks are obtained (e.g. if you need to retrieve some data based on earlier-retrieved data)</li><li>It helps to immediately require the most restrictive locking level you will need during the operation</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="combining-different-strategies">Combining different strategies<a class="hash-link" href="#combining-different-strategies" title="Direct link to heading">​</a></h2><p> It is possible for different locking strategies to exist at different levels in your application!</p><p>Example for scenario where users can edit item descriptions:</p><ul><li>Require users to &quot;check out&quot; item before description can be changed (pessimistic locking)</li><li>At level of DB communication, we could still use optimistic locking to deal with conflicts caused by users concurrently trying to check out the same item</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimistic-locking-implementation-using-sql">Optimistic locking implementation using SQL<a class="hash-link" href="#optimistic-locking-implementation-using-sql" title="Direct link to heading">​</a></h2><p>(examples assume isolation level Read Committed, which is the default level in several popular relational databases and even the lowest available level for some)</p><p>(examples use PostgreSQL dialect)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="where">WHERE<a class="hash-link" href="#where" title="Direct link to heading">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> items</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;newNameA&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">+</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Version number is used to check for conflicts</li><li>Application verifies number of updated rows (returned from DB), if that is 0 we know that a conflict has occurred and we can roll back the transaction</li></ul><p>Note: DB-level locks are still acquired when performing the actual update! This can lead to DB deadlocks if you&#x27;re not careful.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token comment" style="color:#999999">--Transaction A                 -- Transaction B</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">-- 1                            -- 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">BEGIN</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TRANSACTION</span><span class="token plain">               </span><span class="token keyword" style="color:#c5a5c5">BEGIN</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TRANSACTION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> items                    </span><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> items </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;newNameA&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain">          </span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;newNameB&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">+</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain">          version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">+</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">-- 3 - blocks                   -- 4 - deadlock</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> items                    </span><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> items </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;newNameD&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain">          </span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;newNameC&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">+</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain">          version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">+</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">2</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TRANSACTION</span><span class="token plain">              </span><span class="token keyword" style="color:#c5a5c5">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TRANSACTION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The problem: the second update statement in transaction A depends on transaction B being committed or rolled back, while the second update statement in transaction B depends on transaction A being committed or rolled back!</p><p>Solution: make sure to always lock rows in the same order (flexibility of optimistic locking makes this easy)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="outputreturning-or-a-separate-select-query">OUTPUT/RETURNING or a separate SELECT query<a class="hash-link" href="#outputreturning-or-a-separate-select-query" title="Direct link to heading">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> items</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;newName&#x27;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> version </span><span class="token operator" style="color:#d7deea">+</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">RETURNING</span><span class="token plain"> version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Application verifies returned version and rolls back transaction if necessary (we know there was a conflict if version has increased by more than 1 relative to the one we had).</p><p>For databases not supporting the OUTPUT or RETURNING clause, a separate SELECT statement can be used. </p><p>Note that, even without the RETURNING statement, the above query locks the row until the end of the transaction.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pessimistic-locking-implementation-using-sql">Pessimistic locking implementation using SQL<a class="hash-link" href="#pessimistic-locking-implementation-using-sql" title="Direct link to heading">​</a></h2><p>Pessimistic locking typically performed at row level, but similar locks can also be obtained for an entire table (if you are only interested in some specific rows, use row-level locking so you don’t unnecessarily limit concurrency)</p><p>Shared lock on row (held until commit/rollback of the entire transaction):</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> description</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> the_table </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">SHARE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Exclusive lock on row (held until commit/rollback of the entire transaction):</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> description</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> the_table </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">UPDATE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="locking-rows-versus-locking-objects">Locking rows versus locking objects<a class="hash-link" href="#locking-rows-versus-locking-objects" title="Direct link to heading">​</a></h2><p>A single object does not always correspond to a single row in the DB!</p><p>Example: order containing order lines, 1 table for orders and 1 for order lines, the row for an order contains some data based on data in order lines. What if users concurrently add order lines?</p><p>Some approaches:</p><ul><li>Optimistic locking where order has version number that is increased whenever the order or its order lines are changed</li><li>Pessimistic locking with lock on order row whenever we update order or its lines</li><li>Pessimistic locking on order lines table also possible, but row-level locking does not prevent adding new rows!</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alternatives">Alternatives<a class="hash-link" href="#alternatives" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="atomic-updates-and-database-level-restrictions">Atomic updates and database-level restrictions<a class="hash-link" href="#atomic-updates-and-database-level-restrictions" title="Direct link to heading">​</a></h3><p>Basic idea: structure data and application in such a way that all updates are made using atomic UPDATE queries that only update exactly the relevant data</p><ul><li>Could be useful for simple CRUD apps</li><li>Tricky if value A depends on value B but they can be changed separately</li><li>Tricky if relationships are involved</li><li>Does not solve the problem of data being lost if multiple users concurrently edit the description for the same item!</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="database-level-checks-for-status-of-related-object">Database-level checks for status of related object<a class="hash-link" href="#database-level-checks-for-status-of-related-object" title="Direct link to heading">​</a></h4><p>When the validity of an update depends on the status of a related object, you might also be able to put the checks for that at the database level and rely purely on the <a href="/interview-prep/data/sql/acid">ACID</a> guarantees provided by the DB. For example, let&#x27;s say we can link items to a group, but only if the group has status “Active”. We can enforce this at the DB level if we link items to a separate table holding IDs for active groups. This way, if we have a transaction adding an item to a group and a concurrent transaction making that group inactive (thus removing it from the active groups table), the DB will not allow both transactions to succeed.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="find-one-and-update">Find one and update<a class="hash-link" href="#find-one-and-update" title="Direct link to heading">​</a></h4><p>Interesting example: using a single query, find a row matching a certain condition and also update it so it doesn&#x27;t match the condition anymore (example uses SQL Server dialect)</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">TOP</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token number" style="color:#5a9bcf">1</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"> tickets</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> is_available </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">OUTPUT inserted</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">ticket_id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> is_available </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is similar to, for example, MongoDB&#x27;s <code>findOneAndUpdate</code>. The above approach makes sure that the same ticket is not reserved twice, even with multiple clients running this query at the same time.</p><p>If you want to accomplish the same using a separate <code>SELECT</code> query and <code>UPDATE</code> query, you would need to foresee some explicit optimistic/pessimistic locking or use a higher transaction isolation level (see below).</p><p>Note that some other ways of performing the update using a single query do not provide the same guarantees as the query above. For example, this PostgreSQL query is prone to race conditions when executed concurrently by multiple clients and might reserve the same ticket twice:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">WITH</span><span class="token plain"> cte </span><span class="token keyword" style="color:#c5a5c5">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">SELECT</span><span class="token plain"> ticket_id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> tickets</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> is_available </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">UPDATE</span><span class="token plain"> tickets t</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">SET</span><span class="token plain"> is_available </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">FROM</span><span class="token plain"> cte</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">WHERE</span><span class="token plain"> t</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">ticket_id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> cte</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">ticket_id</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">RETURNING</span><span class="token plain"> t</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">ticket_id</span><span class="token punctuation" style="color:#8dc891">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Running this query has more or less the same effect as running a separate <code>SELECT</code> query and <code>UPDATE</code> query. By the time this query gets to the <code>UPDATE</code> part, it&#x27;s possible that the ticket returned from the <code>SELECT</code> has already been updated by another client. In order to prevent race conditions for this query, we&#x27;d need to use pessimistic locking by including <code>FOR UPDATE</code> in the <code>SELECT</code>. Alternatively, we could introduce optimistic locking by adding <code>AND is_available = true</code> to the <code>WHERE</code> clause of the <code>UPDATE</code>, but then we might get no ticket ID back while there are actually still plenty of available tickets in the DB.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higher-transaction-isolation-levels">Higher transaction isolation levels<a class="hash-link" href="#higher-transaction-isolation-levels" title="Direct link to heading">​</a></h3><p>(higher than Read Committed)</p><p>See <a href="/interview-prep/data/sql/transaction-isolation-levels">Transaction isolation levels</a></p><ul><li>Lack of flexibility: For this to work, everything you do as part of an operation needs to happens inside the same database transaction (like pessimistic locking)</li><li>Lose control over what exactly is locked and when<ul><li>Increases likelihood of deadlocks if database uses locking to implement transaction isolation</li></ul></li><li>Behavior varies widely between database vendors or even between different versions of the same database<ul><li>Probably not the best option for applications that need to support multiple databases</li></ul></li><li>Does not solve the problem of lost updates in the example with multiple users concurrently editing the same item’s description</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://en.wikipedia.org/wiki/Concurrency_control" target="_blank" rel="nofollow noopener noreferrer">Concurrency Control <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li><li><a href="https://www.postgresql.org/docs/current/static/dml-returning.html" target="_blank" rel="nofollow noopener noreferrer">PostgreSQL Returning Data From Modified Rows <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li><li><a href="https://www.postgresql.org/docs/current/static/explicit-locking.html" target="_blank" rel="nofollow noopener noreferrer">PostgreSQL Explicit Locking <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li><li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-2017" target="_blank" rel="nofollow noopener noreferrer">SQL Server Transaction Locking and Row Versioning Guide <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/interview-prep/data/sql/normalization"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Database normalization</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/interview-prep/data/sql/transaction-isolation-levels"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Transaction isolation levels</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-locking" class="table-of-contents__link toc-highlight">Why locking?</a></li><li><a href="#optimistic-locking" class="table-of-contents__link toc-highlight">Optimistic locking</a></li><li><a href="#pessimistic-locking" class="table-of-contents__link toc-highlight">Pessimistic locking</a></li><li><a href="#combining-different-strategies" class="table-of-contents__link toc-highlight">Combining different strategies</a></li><li><a href="#optimistic-locking-implementation-using-sql" class="table-of-contents__link toc-highlight">Optimistic locking implementation using SQL</a><ul><li><a href="#where" class="table-of-contents__link toc-highlight">WHERE</a></li><li><a href="#outputreturning-or-a-separate-select-query" class="table-of-contents__link toc-highlight">OUTPUT/RETURNING or a separate SELECT query</a></li></ul></li><li><a href="#pessimistic-locking-implementation-using-sql" class="table-of-contents__link toc-highlight">Pessimistic locking implementation using SQL</a></li><li><a href="#locking-rows-versus-locking-objects" class="table-of-contents__link toc-highlight">Locking rows versus locking objects</a></li><li><a href="#alternatives" class="table-of-contents__link toc-highlight">Alternatives</a><ul><li><a href="#atomic-updates-and-database-level-restrictions" class="table-of-contents__link toc-highlight">Atomic updates and database-level restrictions</a></li><li><a href="#higher-transaction-isolation-levels" class="table-of-contents__link toc-highlight">Higher transaction isolation levels</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">copyright © 2022 shyamzzp.</div></div></div></footer></div>
<script src="/interview-prep/assets/js/runtime~main.a06935e2.js"></script>
<script src="/interview-prep/assets/js/main.05638695.js"></script>
<script>window.goatcounter={no_events:!0},window.addEventListener("click",(t=>{if(!window.goatcounter.count)return;if(!t.target)return;const e=t.target.getAttribute("href");!e||e.startsWith("http")||e.startsWith("#")||setTimeout((()=>{window.goatcounter.count()}))}))</script>
<script data-goatcounter="https://interview-prep.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></body>
</html>