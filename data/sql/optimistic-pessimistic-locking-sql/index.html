<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.50">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileColor" content="#000000">
<meta name="theme-color" content="#ffffff">
<script>const style=document.createElement("style");style.type="text/css",style.textContent=".menu .menu__list .menu__list-item.menu__list-item--collapsed .menu__list{height:0;overflow:hidden}.menu .menu__list .menu__link.menu__link--sublist:after{visibility:visible}.menu .menu__list .menu__list-item.menu__list-item--collapsed .menu__link--sublist:after{visibility:visible}",document.getElementsByTagName("head")[0].appendChild(style)</script>

<title data-react-helmet="true">Optimistic and pessimistic locking in SQL | interview-prep</title>

<meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Optimistic and pessimistic locking in SQL | interview-prep"><meta data-react-helmet="true" name="description" content="How and why to use locking with relational databases"><meta data-react-helmet="true" property="og:description" content="How and why to use locking with relational databases"><meta data-react-helmet="true" property="og:url" content="https://shyamzzp.github.io/interview-prep/data/sql/optimistic-pessimistic-locking-sql">

<link data-react-helmet="true" rel="shortcut icon" href="/interview-prep/favicon.ico">


<link rel="stylesheet" href="/interview-prep/styles.13a95899.css">


<link rel="preload" href="/interview-prep/styles.528f11ec.js" as="script">

<link rel="preload" href="/interview-prep/runtime~main.d8715979.js" as="script">

<link rel="preload" href="/interview-prep/main.a2ac2088.js" as="script">

<link rel="preload" href="/interview-prep/1.a97003e5.js" as="script">

<link rel="preload" href="/interview-prep/2.2e8d12a1.js" as="script">

<link rel="preload" href="/interview-prep/92.c467e56e.js" as="script">

<link rel="preload" href="/interview-prep/7ade5073.5f862e9b.js" as="script">

<link rel="preload" href="/interview-prep/17896441.d7ae5b38.js" as="script">

<link rel="preload" href="/interview-prep/ee0143f8.676fd950.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<svg style="display: none;"><desc>Font Awesome Free 5.13.0 by @fontawesome - https://fontawesome.com
            License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)</desc>
            <symbol id="external-link-alt" viewBox="0 0 512 512">
                <path d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path>
            </symbol>
            <symbol id="github" viewBox="0 0 496 512">
                <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path>
            </symbol></svg>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/interview-prep/"><strong class="navbar__title">Interview Preparation Notes</strong></a></div><div class="navbar__items navbar__items--right"><a target="_blank" rel="noopener noreferrer" href="https://github.com/shyamzzp/interview-prep" class="header-github-link navbar__item navbar__link" aria-label="GitHub repository"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/interview-prep/"><strong class="navbar__title">Interview Preparation Notes</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://github.com/shyamzzp/interview-prep" class="header-github-link navbar__item navbar__link" aria-label="GitHub repository"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">About</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/about/about">About these notes</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/about/solving-leetcode-problems">Solving Leetcode Questions</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Data</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/data/cap-theorem">CAP theorem</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/data/data-schema-migration">Data schema migration</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/data/sql-nosql-newsql">SQL, NoSQL, NewSQL</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">SQL</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/data/sql/acid">ACID properties</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/data/sql/normalization">Database normalization</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/interview-prep/data/sql/optimistic-pessimistic-locking-sql">Optimistic and pessimistic locking in SQL</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/data/sql/transaction-isolation-levels">Transaction isolation levels</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Java</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/concurrency">Concurrency</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/date-time-api">Date and Time API</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/equals">Equals</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/exceptions">Exceptions</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/generics">Generics</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/interfaces">Interfaces</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/java-platform-module-system">Java Platform Module System</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/lambda-expressions">Lambda expressions</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/optional">Optional type</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/overloading-overriding-method-hiding">Overloading, overriding and method hiding</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/streams">Streams</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Concurrency details</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/concurrency-details/locking">Locking</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/concurrency-details/thread-safety">Thread safety</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/java/concurrency-details/threads">Threads</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">JavaScript</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/event-loop">Event loop</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/object-prototypes-classes">Object prototypes and classes</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/scope-closures">Scope and closures</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/spread-syntax-rest-parameters-destructuring">Spread syntax, rest parameters and destructuring</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/this-keyword">The this keyword</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">TypeScript</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/typescript/compiler-api">Compiler API</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/typescript/conditional-types">Conditional types</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/typescript/index-types">Index types</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/typescript/nullable-types-optional-parameters-properties">Nullable types and optional parameters/properties</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/typescript/runtime-type-checking">Runtime type checking in TypeScript</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/javascript/typescript/type-guards">Type guards</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Mindset</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/ask-dumb-questions">Ask the dumb questions</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/concepts-not-code">Concepts, not code</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/fail-fast">Fail fast</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/hammock-driven-development">Hammock-driven development</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/it-depends">It depends</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/its-about-people">It&#x27;s about people</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/keep-it-simple">Keep it simple</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/pragmatism-imperfectionism">Pragmatism and imperfectionism</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/mindset/work-life-balance">Work-life balance</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Preparation (Java)</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/algorithms">Algorithms</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/bit-manipulation">Bit Manipulation</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/common-problems">Common Problems</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/comparators">Comparators</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/graph">Graph</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/linked-list">Linked List</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/map">Map</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/math">Math</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/priority-queue">Priority Queue</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/search-algorithms">Search Algorithms</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/snippets">Snippets</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/sorting-algorithms">Sorting Algorithms</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/preparation/tree">Tree</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Processes and techniques</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/branch-by-abstraction-application-strangulation">Branch By Abstraction and application strangulation</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/client-first-design">Client-first design</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/code-review-collaboration">Code review and collaboration workflows</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/dealing-with-uncertainty">Dealing with uncertainty</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/feature-flags">Feature flags</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/issue-troubleshooting">Issue troubleshooting</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/managing-technical-debt">Managing technical debt</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/refactoring">Refactoring</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/small-commits-pull-requests">Small commits and pull requests</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/static-analysis">Static analysis</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/team-decision-making">Team decision-making</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/testing">Testing</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/trunk-based-development">Trunk Based Development</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Testing details</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/testing-details/testing-after-production">Testing after production</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/processes-techniques/testing-details/testing-patterns">Testing patterns</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Soft skills</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/soft-skills/expectation-management">Expectation management</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Web</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/cookies-web-storage">Cookies and Web Storage</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CSS</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/box-model">Box model</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/browser-compatibility">Browser compatibility</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/flexbox">Flexbox</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/grids">Grids</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/inheritance-cascade-specificity">Inheritance, the cascade and specificity</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/naming-classes">Naming classes</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/positioning">Positioning</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/responsive-design">Responsive design</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/sass-scss">Sass/SCSS</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/selectors">Selectors</a></li><li class="menu__list-item"><a class="menu__link" href="/interview-prep/web/css/units">Units</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Optimistic and pessimistic locking in SQL</h1></header><div class="markdown"><p>How and why to use locking with relational databases</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="why-locking"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#why-locking" title="Direct link to heading">#</a>Why locking?</h2><p>Concurrency!</p><p>Some scenarios:</p><ul><li>Your application lets users manage items. Each item has a long description. One of your users starts editing the description of item A at 10:00 and saves his changes at 10:02. Meanwhile, another user starts editing the same item’s description at 10:01 and saves it at 10:03. Because the original description that the second user started from did not yet contain the changes made by the first user, the changes made by the first user are lost without either user being notified about it.</li><li>Your application communicates with the database through an ORM using the common approach where you retrieve the current version of an object, make some changes to it and then save the entire resulting object to the database. Some user or process changes the same object right after you retrieved it, so the object you are saving does not contain those changes. This leads to your application overwriting the changes with stale data.</li><li>Your application allows linking items to a group, but only if the group has status “Active”. This restriction is not enforced at the database-level. Before linking an item to a group, you verify that the group has the correct status. However, just before you save the item, another user or process changes the status of the group to “Inactive”. Once you commit, the item is now linked to an inactive group.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="optimistic-locking"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#optimistic-locking" title="Direct link to heading">#</a>Optimistic locking</h2><p>(some prefer the term &quot;optimistic concurrency control&quot;  because, unlike pessimistic locking, it does not explicitly lock resources)</p><ul><li>Perform most of the operation under assumption that no conflicting operations have occurred</li><li>Just before saving/committing, verify that no conflicts have occurred and abort otherwise</li></ul><p>In SQL, two approaches:</p><ul><li>Compare actual data to data you based yourself on when performing the operation</li><li>Using a version number or timestamp that changes ever time the data changes</li></ul><p>Can be used to retrieve object, make some changes to it and then save and verify that no other changes have been made in the meantime. Could also use same mechanism to verify that a certain object you needed simply didn&#x27;t change.</p><p>Benefits:</p><ul><li>Flexibility: don&#x27;t have to care about where or when the &quot;base version&quot; was retrieved. Could have been in different transaction, could have been 15 minutes ago when a user started editing, ...</li><li>Deadlocks are less likely and it&#x27;s straightforward to prevent them by always saving object in same order (DB-level locks are only acquired when saving)</li></ul><p>Drawbacks:</p><ul><li>If conflict does occur, you need to deal with operation being aborted<ul><li>Retrying can make sense in some scenarios<ul><li>Example: ORM retrieves object, makes changes and immediately saves it. If the operation fails, we can retrieve the most recent version and then try making our changes on that one.</li><li>Note: a conflict means that data has changed, might invalidate some precondition!</li><li>Note: retry attempts should likely be limited, leading to the possibility for failure again!</li></ul></li><li>Retrying does not make sense in first scenario (users concurrently editing descriptions), because it would just let users unknowingly overwrite each other&#x27;s changes again. Here, we need user input (e.g. manual merging of changes)!</li></ul></li><li>Not ideal if there&#x27;s lot of conflicting access to the same resource<ul><li>In that case, you would be aborting operations all the time</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="pessimistic-locking"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pessimistic-locking" title="Direct link to heading">#</a>Pessimistic locking</h2><ul><li>Assume conflicting operations will occur</li><li>Actively block anything that might lead to a conflict</li></ul><p>Works by actively locking database rows (or even entire tables) that you need in your operation.</p><p>Types of locks:</p><ul><li>Shared locks (read locks): <ul><li>use on data you just need to stay the same until your operation completes</li><li>allow other shared locks on the same data</li></ul></li><li>Exclusive locks (write locks):<ul><li>use for reading and writing data you want to update</li><li>do not allow any other lock on the same data before transaction is committed or rolled back</li></ul></li></ul><p>Attempts to obtain a lock when it&#x27;s not allowed will typically block until the conflicting locks are released -&gt; deadlock potential!</p><p>Benefits:</p><ul><li>Completely prevents conflicts from occurring! <ul><li>Could actually be best-performing strategy in high-concurrency environments</li></ul></li></ul><p>Drawbacks</p><ul><li>Misses the flexibility of optimistic locking: everything needs to happen inside same DB transaction<ul><li>Impractical for scenarios that need to wait for user input (and what if input never comes?)</li><li>Can limit options for the way codebase is organized</li></ul></li><li>Could unnecessarily limit concurrency</li><li>Special care needed to prevent deadlocks!<ul><li>Locks acquired at start of operation -&gt; more locking</li><li>Less flexibility regarding order in which locks are obtained (e.g. if you need to retrieve some data based on earlier-retrieved data)</li><li>It helps to immediately require the most restrictive locking level you will need during the operation</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="combining-different-strategies"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#combining-different-strategies" title="Direct link to heading">#</a>Combining different strategies</h2><p> It is possible for different locking strategies to exist at different levels in your application!</p><p>Example for scenario where users can edit item descriptions:</p><ul><li>Require users to &quot;check out&quot; item before description can be changed (pessimistic locking)</li><li>At level of DB communication, we could still use optimistic locking to deal with conflicts caused by users concurrently trying to check out the same item</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="optimistic-locking-implementation-using-sql"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#optimistic-locking-implementation-using-sql" title="Direct link to heading">#</a>Optimistic locking implementation using SQL</h2><p>(examples assume isolation level Read Committed, which is the default level in several popular relational databases and even the lowest available level for some)</p><p>(examples use PostgreSQL dialect)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="where"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#where" title="Direct link to heading">#</a>WHERE</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> items</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;newNameA&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span></div></div></div></div></div><ul><li>Version number is used to check for conflicts</li><li>Application verifies number of updated rows (returned from DB), if that is 0 we know that a conflict has occurred and we can roll back the transaction</li></ul><p>Note: DB-level locks are still acquired when performing the actual update! This can lead to DB deadlocks if you&#x27;re not careful.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">--Transaction A                 -- Transaction B</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 1                            -- 2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRANSACTION</span><span class="token plain">               </span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRANSACTION</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> items                    </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> items </span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;newNameA&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;newNameB&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 3 - blocks                   -- 4 - deadlock</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> items                    </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> items </span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;newNameD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;newNameC&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRANSACTION</span><span class="token plain">              </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRANSACTION</span></div></div></div></div></div><p>The problem: the second update statement in transaction A depends on transaction B being committed or rolled back, while the second update statement in transaction B depends on transaction A being committed or rolled back!</p><p>Solution: make sure to always lock rows in the same order (flexibility of optimistic locking makes this easy)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="outputreturning-or-a-separate-select-query"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#outputreturning-or-a-separate-select-query" title="Direct link to heading">#</a>OUTPUT/RETURNING or a separate SELECT query</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> items</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;newName&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">RETURNING version</span></div></div></div></div></div><p>Application verifies returned version and rolls back transaction if necessary (we know there was a conflict if version has increased by more than 1 relative to the one we had).</p><p>For databases not supporting the OUTPUT or RETURNING clause, a separate SELECT statement can be used. </p><p>Note that, even without the RETURNING statement, the above query locks the row until the end of the transaction.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="pessimistic-locking-implementation-using-sql"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pessimistic-locking-implementation-using-sql" title="Direct link to heading">#</a>Pessimistic locking implementation using SQL</h2><p>Pessimistic locking typically performed at row level, but similar locks can also be obtained for an entire table (if you are only interested in some specific rows, use row-level locking so you don’t unnecessarily limit concurrency)</p><p>Shared lock on row (held until commit/rollback of the entire transaction):</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> description</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> the_table </span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SHARE</span></div></div></div></div></div><p>Exclusive lock on row (held until commit/rollback of the entire transaction):</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> description</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> the_table </span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="locking-rows-versus-locking-objects"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#locking-rows-versus-locking-objects" title="Direct link to heading">#</a>Locking rows versus locking objects</h2><p>A single object does not always correspond to a single row in the DB!</p><p>Example: order containing order lines, 1 table for orders and 1 for order lines, the row for an order contains some data based on data in order lines. What if users concurrently add order lines?</p><p>Some approaches:</p><ul><li>Optimistic locking where order has version number that is increased whenever the order or its order lines are changed</li><li>Pessimistic locking with lock on order row whenever we update order or its lines</li><li>Pessimistic locking on order lines table also possible, but row-level locking does not prevent adding new rows!</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="alternatives"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#alternatives" title="Direct link to heading">#</a>Alternatives</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="atomic-updates-and-database-level-restrictions"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#atomic-updates-and-database-level-restrictions" title="Direct link to heading">#</a>Atomic updates and database-level restrictions</h3><p>Basic idea: structure data and application in such a way that all updates are made using atomic UPDATE queries that only update exactly the relevant data</p><ul><li>Could be useful for simple CRUD apps</li><li>Tricky if value A depends on value B but they can be changed separately</li><li>Tricky if relationships are involved</li><li>Does not solve the problem of data being lost if multiple users concurrently edit the description for the same item!</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="database-level-checks-for-status-of-related-object"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#database-level-checks-for-status-of-related-object" title="Direct link to heading">#</a>Database-level checks for status of related object</h4><p>When the validity of an update depends on the status of a related object, you might also be able to put the checks for that at the database level and rely purely on the <a href="/data/sql/acid">ACID</a> guarantees provided by the DB. For example, let&#x27;s say we can link items to a group, but only if the group has status “Active”. We can enforce this at the DB level if we link items to a separate table holding IDs for active groups. This way, if we have a transaction adding an item to a group and a concurrent transaction making that group inactive (thus removing it from the active groups table), the DB will not allow both transactions to succeed.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="find-one-and-update"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#find-one-and-update" title="Direct link to heading">#</a>Find one and update</h4><p>Interesting example: using a single query, find a row matching a certain condition and also update it so it doesn&#x27;t match the condition anymore (example uses SQL Server dialect)</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TOP</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> tickets</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> is_available </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">OUTPUT inserted</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ticket_id</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> is_available </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span></div></div></div></div></div><p>This is similar to, for example, MongoDB&#x27;s <code>findOneAndUpdate</code>. The above approach makes sure that the same ticket is not reserved twice, even with multiple clients running this query at the same time.</p><p>If you want to accomplish the same using a separate <code>SELECT</code> query and <code>UPDATE</code> query, you would need to foresee some explicit optimistic/pessimistic locking or use a higher transaction isolation level (see below).</p><p>Note that some other ways of performing the update using a single query do not provide the same guarantees as the query above. For example, this PostgreSQL query is prone to race conditions when executed concurrently by multiple clients and might reserve the same ticket twice:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> cte </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> ticket_id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tickets</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> is_available </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> tickets t</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> is_available </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cte</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ticket_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cte</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ticket_id</span></div><div class="token-line" style="color:#393A34"><span class="token plain">RETURNING t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ticket_id</span><span class="token punctuation" style="color:#393A34">;</span></div></div></div></div></div><p>Running this query has more or less the same effect as running a separate <code>SELECT</code> query and <code>UPDATE</code> query. By the time this query gets to the <code>UPDATE</code> part, it&#x27;s possible that the ticket returned from the <code>SELECT</code> has already been updated by another client. In order to prevent race conditions for this query, we&#x27;d need to use pessimistic locking by including <code>FOR UPDATE</code> in the <code>SELECT</code>. Alternatively, we could introduce optimistic locking by adding <code>AND is_available = true</code> to the <code>WHERE</code> clause of the <code>UPDATE</code>, but then we might get no ticket ID back while there are actually still plenty of available tickets in the DB.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="higher-transaction-isolation-levels"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#higher-transaction-isolation-levels" title="Direct link to heading">#</a>Higher transaction isolation levels</h3><p>(higher than Read Committed)</p><p>See <a href="/data/sql/transaction-isolation-levels">Transaction isolation levels</a></p><ul><li>Lack of flexibility: For this to work, everything you do as part of an operation needs to happens inside the same database transaction (like pessimistic locking)</li><li>Lose control over what exactly is locked and when<ul><li>Increases likelihood of deadlocks if database uses locking to implement transaction isolation</li></ul></li><li>Behavior varies widely between database vendors or even between different versions of the same database<ul><li>Probably not the best option for applications that need to support multiple databases</li></ul></li><li>Does not solve the problem of lost updates in the example with multiple users concurrently editing the same item’s description</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="resources"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#resources" title="Direct link to heading">#</a>Resources</h2><ul><li><a href="https://en.wikipedia.org/wiki/Concurrency_control" target="_blank" rel="nofollow noopener noreferrer">Concurrency Control <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li><li><a href="https://www.postgresql.org/docs/current/static/dml-returning.html" target="_blank" rel="nofollow noopener noreferrer">PostgreSQL Returning Data From Modified Rows <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li><li><a href="https://www.postgresql.org/docs/current/static/explicit-locking.html" target="_blank" rel="nofollow noopener noreferrer">PostgreSQL Explicit Locking <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li><li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-2017" target="_blank" rel="nofollow noopener noreferrer">SQL Server Transaction Locking and Row Versioning Guide <svg class="embedded-fa-icon"><use href="#external-link-alt"></use></svg></a></li></ul></div></article><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/interview-prep/data/sql/normalization"><div class="pagination-nav__link--sublabel">Previous</div><div class="pagination-nav__link--label">« Database normalization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/interview-prep/data/sql/transaction-isolation-levels"><div class="pagination-nav__link--sublabel">Next</div><div class="pagination-nav__link--label">Transaction isolation levels »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#why-locking" class="contents__link">Why locking?</a></li><li><a href="#optimistic-locking" class="contents__link">Optimistic locking</a></li><li><a href="#pessimistic-locking" class="contents__link">Pessimistic locking</a></li><li><a href="#combining-different-strategies" class="contents__link">Combining different strategies</a></li><li><a href="#optimistic-locking-implementation-using-sql" class="contents__link">Optimistic locking implementation using SQL</a><ul><li><a href="#where" class="contents__link">WHERE</a></li><li><a href="#outputreturning-or-a-separate-select-query" class="contents__link">OUTPUT/RETURNING or a separate SELECT query</a></li></ul></li><li><a href="#pessimistic-locking-implementation-using-sql" class="contents__link">Pessimistic locking implementation using SQL</a></li><li><a href="#locking-rows-versus-locking-objects" class="contents__link">Locking rows versus locking objects</a></li><li><a href="#alternatives" class="contents__link">Alternatives</a><ul><li><a href="#atomic-updates-and-database-level-restrictions" class="contents__link">Atomic updates and database-level restrictions</a></li><li><a href="#higher-transaction-isolation-levels" class="contents__link">Higher transaction isolation levels</a></li></ul></li><li><a href="#resources" class="contents__link">Resources</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>copyright © 2022 shyamzzp.</div></div></div></footer>
</div>

<script src="/interview-prep/styles.528f11ec.js"></script>

<script src="/interview-prep/runtime~main.d8715979.js"></script>

<script src="/interview-prep/main.a2ac2088.js"></script>

<script src="/interview-prep/1.a97003e5.js"></script>

<script src="/interview-prep/2.2e8d12a1.js"></script>

<script src="/interview-prep/92.c467e56e.js"></script>

<script src="/interview-prep/7ade5073.5f862e9b.js"></script>

<script src="/interview-prep/17896441.d7ae5b38.js"></script>

<script src="/interview-prep/ee0143f8.676fd950.js"></script>

<script>window.goatcounter={no_events:!0},window.addEventListener("click",t=>{if(!window.goatcounter.count)return;if(!t.target)return;const e=t.target.getAttribute("href");!e||e.startsWith("http")||e.startsWith("#")||setTimeout(()=>{window.goatcounter.count()})})</script>
<script data-goatcounter="https://interview-prep.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>